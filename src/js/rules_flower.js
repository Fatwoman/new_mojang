// ======================================================================
// rules_flower.jsï¼ˆå°ç£éº»å°‡ãƒ»å®Œæ•´ç‰ˆï¼‰
//
// åŠŸèƒ½ï¼š
//   1. åˆ¤æ–·æ˜¯å¦ç‚ºèŠ±ç‰Œ
//   2. å››å­£ / æ¢…è˜­ç«¹èŠçš„èŠ±è™Ÿè§£æ
//   3. è‡ªå‹•è£œèŠ±ï¼ˆæ‘¸åˆ°èŠ± â†’ æ”¾èŠ± â†’ å¾ç‰†å°¾è£œç‰Œï¼‰
//   4. è¨ˆç®—èŠ±å°ï¼ˆçµ¦ rules_score.js ç”¨ï¼‰
//
// æœ¬æª”æ¡ˆï¼š
//   âŒ ä¸è™•ç† UI
//   âŒ ä¸è™•ç† Firebase
//   âŒ ä¸æ›´æ–°å±€æ•¸
//   âŒ ä¸è™•ç†åƒç¢°æ§“èƒ¡
//   âœ” å°ˆé–€è² è²¬ï¼šè£œèŠ± + èŠ±å° + èŠ±è³‡æ–™ç®¡ç†
//
// ğŸ“Œ ç‰¹åˆ¥èªªæ˜ï¼ˆè·Ÿä½ ç¾åœ¨çš„åœ–ç‰‡æª”åå°é½Šï¼‰ï¼š
//   æ˜¥å¤ç§‹å†¬   â†’ 1F, 2F, 3F, 4F   ï¼ˆå°¾ç¢¼ Fï¼‰
//   æ¢…è˜­ç«¹èŠ   â†’ 1P, 2P, 3P, 4P   ï¼ˆå°¾ç¢¼ Pï¼‰
//
//   å°æ‡‰åˆ°ã€Œæ•¸å­— 1~8ã€çš„é‚è¼¯ï¼š
//     1F â†’ 1 = æ˜¥
//     2F â†’ 2 = å¤
//     3F â†’ 3 = ç§‹
//     4F â†’ 4 = å†¬
//     1P â†’ 5 = æ¢…
//     2P â†’ 6 = è˜­
//     3P â†’ 7 = ç«¹
//     4P â†’ 8 = èŠ
//
//   ä¹Ÿå°±æ˜¯èªªï¼šP çµ„çš„æœƒåœ¨ç¨‹å¼è£¡è¢« +4 è®Šæˆ 5~8ã€‚
// ======================================================================

// ======================================================================
// 1. èŠ±ç‰Œå®šç¾©ï¼ˆå°ç£éº»å°‡ 8 å¼µèŠ±ï¼‰
// ======================================================================

// å››å­£ï¼šæ˜¥å¤ç§‹å†¬ â†’ 1F~4F
const SEASON_FLOWERS = ["1F", "2F", "3F", "4F"];

// æ¢…è˜­ç«¹èŠ â†’ 1P~4P
const PLANT_FLOWERS = ["1P", "2P", "3P", "4P"];

// å…¨éƒ¨èŠ±ç‰Œé›†åˆï¼ˆæ–¹ä¾¿ includes åˆ¤æ–·ï¼‰
const FLOWER_SET = [...SEASON_FLOWERS, ...PLANT_FLOWERS];

// ======================================================================
// 2. åˆ¤æ–·æ˜¯å¦ç‚ºèŠ±ç‰Œ
// ======================================================================

/**
 * åˆ¤æ–·æŸå¼µ tile æ˜¯å¦ç‚ºèŠ±ç‰Œ
 * @param {string} tile - ä¾‹å¦‚ "1F", "3P"
 * @returns {boolean}
 */
export function isFlower(tile) {
  // ç›´æ¥çœ‹é€™å¼µç‰Œæ˜¯ä¸æ˜¯åœ¨ FLOWER_SET é€™å€‹é™£åˆ—è£¡
  return FLOWER_SET.includes(tile);
}

// ======================================================================
// 3. å–å¾—èŠ±çš„æ•¸å­—ï¼ˆ1~4 = å››å­£ / 5~8 = æ¢…è˜­ç«¹èŠï¼‰
// ======================================================================

/**
 * å–å¾—èŠ±çš„ã€Œç·¨è™Ÿã€1~8
 *
 *  1F â†’ 1 = æ˜¥
 *  2F â†’ 2 = å¤
 *  3F â†’ 3 = ç§‹
 *  4F â†’ 4 = å†¬
 *  1P â†’ 5 = æ¢…
 *  2P â†’ 6 = è˜­
 *  3P â†’ 7 = ç«¹
 *  4P â†’ 8 = èŠ
 *
 * @param {string} tile - èŠ±ç‰Œï¼ˆ1F~4F, 1P~4Pï¼‰
 * @returns {number|null} - 1~8ï¼›ä¸æ˜¯èŠ±ç‰Œå‰‡å›å‚³ null
 */
export function getFlowerNumber(tile) {
  // é˜²å‘†ï¼šå¦‚æœä¸æ˜¯èŠ±ç‰Œç›´æ¥å›å‚³ null
  if (!isFlower(tile)) return null;

  // å–å‡ºå‰é¢çš„æ•¸å­—éƒ¨åˆ†ï¼ˆ"1F" â†’ 1ï¼‰
  const num = parseInt(tile, 10); // 1~4
  const suit = tile.slice(-1); // "F" æˆ– "P"

  // F çµ„ï¼šæ˜¥å¤ç§‹å†¬ â†’ ç›´æ¥ç”¨ 1~4
  if (suit === "F") {
    return num; // 1~4
  }

  // P çµ„ï¼šæ¢…è˜­ç«¹èŠ â†’ åœ¨ 1~4 åŸºç¤ä¸Š +4 è®Š 5~8
  if (suit === "P") {
    return num + 4; // 5~8
  }

  // ç†è«–ä¸Šä¸æœƒåˆ°é€™è£¡ï¼ˆå› ç‚ºå‰é¢å·²ç¶“åˆ¤æ–·æ˜¯èŠ±ç‰Œï¼‰
  return null;
}

// ======================================================================
// 4. æ–°å¢èŠ±ç‰Œè³‡æ–™ï¼ˆåŠ å…¥ç©å®¶çš„ flower listï¼‰
// ======================================================================

/**
 * å°‡èŠ±ç‰ŒåŠ å…¥ç©å®¶èŠ±å€
 *
 * @param {number} seat - ç©å®¶ seat (0~3)
 * @param {string} tile - èŠ±ç‰Œç·¨ç¢¼ï¼ˆ1F~4F, 1P~4Pï¼‰
 * @param {object} flowerState - èŠ±è³‡æ–™ç®¡ç†ç‰©ä»¶
 *
 * flowerState çµæ§‹ï¼š
 * {
 *   flowers: [[], [], [], []],  // å››å®¶çš„èŠ±ç‰Œé™£åˆ—
 *   flowerCount: [0, 0, 0, 0]   // å››å®¶çš„ã€ŒèŠ±å°ã€ç¸½æ•¸
 * }
 */
export function addFlower(seat, tile, flowerState) {
  flowerState.flowers[seat].push(tile);
}

// ======================================================================
// 5. è¨ˆç®—èŠ±å°ï¼ˆçµ¦ rules_score.js ä½¿ç”¨ï¼‰
// ======================================================================

/**
 * è¨ˆç®—æŸå®¶ seat çš„èŠ±å°æ•¸
 *
 * è¦å‰‡ï¼ˆå…¸å‹å°ç£éº»å°‡ï¼‰ï¼š
 *   â€¢ å››å­£ 1~4ï¼ˆæ˜¥å¤ç§‹å†¬ï¼‰ï¼š
 *       åªæœ‰ã€Œè‡ªå®¶èŠ±ã€æ‰ç®— 1 å°
 *       seat 0 = æ±å®¶ â†’ æ˜¥(1)
 *       seat 1 = å—å®¶ â†’ å¤(2)
 *       seat 2 = è¥¿å®¶ â†’ ç§‹(3)
 *       seat 3 = åŒ—å®¶ â†’ å†¬(4)
 *
 *   â€¢ æ¢…è˜­ç«¹èŠ 5~8ï¼š
 *       æ¯å¼µ +1 å°ï¼Œä¸åˆ†å®¶
 *
 * @param {number} seat - ç©å®¶ä½ç½® 0~3
 * @param {object} flowerState - { flowers:[...], flowerCount:[...] }
 *
 * @returns {object}ï¼š
 *   {
 *      totalFlowerFan: n,      // ç¸½èŠ±å°
 *      details: ["æ˜¥ï¼ˆè‡ªå®¶èŠ±ï¼‰ +1", "æ¢… +1", ...]  // æ–‡å­—èªªæ˜
 *   }
 */
export function calculateFlowerFan(seat, flowerState) {
  const flowers = flowerState.flowers[seat] || [];
  const details = [];
  let fan = 0;

  for (const tile of flowers) {
    const num = getFlowerNumber(tile); // 1~8
    if (!num) continue; // ç†è«–ä¸Šä¸æœƒï¼Œä½†é˜²å‘†

    // --------------------------
    // 1~4ï¼šå››å­£ â†’ seat+1 == num æ‰ +1ï¼ˆè‡ªå®¶èŠ±ï¼‰
    // --------------------------
    if (num >= 1 && num <= 4) {
      const name = ["æ˜¥", "å¤", "ç§‹", "å†¬"][num - 1];

      if (num === seat + 1) {
        // è‡ªå®¶èŠ± â†’ +1 å°
        fan++;
        details.push(`${name}ï¼ˆè‡ªå®¶èŠ±ï¼‰ +1`);
      } else {
        // ä¸æ˜¯è‡ªå®¶èŠ± â†’ å°ç£è¦å‰‡é€šå¸¸ä¸åŠ å°ï¼Œåªåšç´€éŒ„
        details.push(`${name}ï¼ˆéè‡ªå®¶ï¼Œä¸åŠ å°ï¼‰`);
      }
    }

    // --------------------------
    // 5~8ï¼šæ¢…è˜­ç«¹èŠ â†’ æ¯å¼µ +1 å°
    // --------------------------
    if (num >= 5 && num <= 8) {
      const name = ["æ¢…", "è˜­", "ç«¹", "èŠ"][num - 5];
      fan++;
      details.push(`${name} +1`);
    }
  }

  return {
    totalFlowerFan: fan,
    details,
  };
}

// ======================================================================
// 6. è‡ªå‹•è£œèŠ±æµç¨‹ï¼ˆæ‘¸åˆ°èŠ± â†’ æ”¾èŠ± â†’ å¾ç‰†å°¾è£œç‰Œï¼‰
// ======================================================================
//
// ä½¿ç”¨æ™‚æ©Ÿï¼š
//   â€¢ table.js åœ¨ç©å®¶ã€Œæ‘¸ç‰Œã€ä¹‹å¾Œå‘¼å«ï¼š
//       autoCatchFlowers(hands[seat], wall, seat, flowerState);
//
// æµç¨‹ï¼š
//   1. åœ¨ hand è£¡æ‰¾å‡ºä»»ä½•ä¸€å¼µèŠ±ç‰Œ
//   2. å¦‚æœæ²’æœ‰èŠ±ç‰Œ â†’ çµæŸï¼ˆdone = trueï¼‰
//   3. å¦‚æœæœ‰ï¼š
//        a. å¾æ‰‹ç‰Œç§»é™¤é€™å¼µèŠ±
//        b. æ”¾é€² flowerState.flowers[seat]
//        c. å³æ™‚è¨ˆç®—é€™å¼µèŠ±å¸¶ä¾†çš„å°æ•¸ï¼Œç´¯åŠ åˆ° flowerState.flowerCount
//        d. å¾ wall å°¾ç«¯ pop ä¸€å¼µè£œç‰Œ
//        e. æŠŠè£œç‰Œ push å›æ‰‹ç‰Œ
//        f. å¦‚æœè£œåˆ°åˆæ˜¯èŠ± â†’ å›åˆ° step 1 ç¹¼çºŒ
//
//   â­ åªè² è²¬ã€Œé‚è¼¯ã€ï¼š
//       - ä¸æœƒå‘¼å« UIï¼ˆç•«é¢æ›´æ–°ç”± table.js åšï¼‰
//       - ä¸æœƒè™•ç† Firebaseï¼ˆåŒæ­¥ç”± table.js / online_resolve.js åšï¼‰
// ======================================================================

/**
 * è‡ªå‹•è£œèŠ±æµç¨‹
 *
 * @param {Array<string>} hand  - æ‰‹ç‰Œï¼ˆå·²åŒ…å«å‰›æ‘¸åˆ°çš„é‚£å¼µç‰Œï¼‰
 * @param {Array<string>} wall  - ç‰Œç‰†ï¼ˆå¾å°¾å·´è£œç‰Œï¼‰
 * @param {number} seat         - ç©å®¶åº§ä½ 0~3
 * @param {object} flowerState  - èŠ±è³‡æ–™ç®¡ç†ï¼ˆåŒä¸Šï¼‰
 *
 * @returns {object}ï¼š
 *   {
 *      hand,                // æ›´æ–°å¾Œçš„æ‰‹ç‰Œï¼ˆèŠ±å·²ç§»é™¤ï¼Œè£œç‰Œå·²åŠ å…¥ï¼‰
 *      wall,                // æ›´æ–°å¾Œçš„ç‰Œç‰†ï¼ˆè¢«è£œæ‰å¹¾å¼µï¼‰
 *      newFlowers: [...],   // é€™ä¸€æ¬¡æµç¨‹æ–°å¢çš„èŠ±ç‰Œï¼ˆä¾‹å¦‚ ["1F","3P"]ï¼‰
 *      newFlowerFan: n      // é€™ä¸€æ¬¡æµç¨‹æ–°å¢çš„èŠ±å°æ•¸
 *   }
 */
export function autoCatchFlowers(hand, wall, seat, flowerState) {
  const newFlowers = []; // æœ¬æ¬¡è£œèŠ±éç¨‹ä¸­æŠ“åˆ°çš„èŠ±ç‰Œ
  let newFlowerFan = 0; // æœ¬æ¬¡å¤šå‡ºä¾†çš„å°æ•¸

  let done = false;

  while (!done) {
    // 1. åœ¨æ‰‹ç‰Œä¸­æ‰¾ä¸€å¼µèŠ±ç‰Œï¼ˆåªæ‰¾ç¬¬ä¸€å¼µï¼‰
    const flowerTile = hand.find((t) => isFlower(t));

    // æ²’æ‰¾åˆ°èŠ±ç‰Œ â†’ çµæŸ while
    if (!flowerTile) {
      done = true;
      break;
    }

    // 2. å¾æ‰‹ç‰Œç§»é™¤é€™å¼µèŠ±
    const idx = hand.indexOf(flowerTile);
    if (idx >= 0) {
      hand.splice(idx, 1);
    }

    // 3. æ”¾å…¥ç©å®¶çš„èŠ±å€
    addFlower(seat, flowerTile, flowerState);
    newFlowers.push(flowerTile);

    // 4. è¨ˆç®—é€™å¼µèŠ±çš„å°æ•¸ï¼ˆå³æ™‚è¨ˆç®—ï¼‰
    const num = getFlowerNumber(flowerTile); // 1~8

    // å››å­£ï¼š1~4 â†’ åªæœ‰ã€Œè‡ªå®¶èŠ±ã€æ‰ +1 å°
    if (num >= 1 && num <= 4) {
      if (num === seat + 1) {
        newFlowerFan++;
        flowerState.flowerCount[seat] += 1;
      }
    }

    // æ¢…è˜­ç«¹èŠï¼š5~8 â†’ æ¯å¼µ +1 å°
    if (num >= 5 && num <= 8) {
      newFlowerFan++;
      flowerState.flowerCount[seat] += 1;
    }

    // 5. å¾ç‰Œç‰†å°¾ç«¯è£œä¸€å¼µç‰Œ
    const replacement = wall.pop();

    // è‹¥å·²ç¶“æ²’æœ‰ç‰Œå¯è£œï¼ˆæ¥è¿‘æµå±€çš„æ¥µç«¯ç‹€æ³ï¼‰
    if (!replacement) {
      done = true;
      break;
    }

    // 6. è£œç‰ŒåŠ å…¥æ‰‹ç‰Œï¼ˆå¯èƒ½åˆæ˜¯èŠ± â†’ ä¹‹å¾Œæœƒå†è¢« while æ‰¾åˆ°ï¼‰
    hand.push(replacement);
  }

  // æŠŠé€™æ¬¡çš„çµæœå›å‚³çµ¦ table.js
  return {
    hand,
    wall,
    newFlowers,
    newFlowerFan,
  };
}
