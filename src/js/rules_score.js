// ======================================================================
// rules_score.js（台灣麻將・台數計算器）
// 負責：根據 fanInfo + 花台 + 特殊情況 計算所有台數
//
// 來源資料：
//   - rules_hu.js → fanInfo（基本胡牌資訊）
//   - rules_flower.js → 花台花數
//   - table.js → 搶槓 / 海底 / 河底 / 天胡 / 地胡...
//
// ======================================================================

/**
 * 計算台數主函式
 *
 * @param {object} fanInfo - 來自 rules_hu.js
 * @param {object} opt - table.js 傳入的其他條件
 *
 * opt = {
 *   flowers,
 *   isPengPeng,
 *   has123,
 *   has789,
 *   isHaiDi,
 *   isHeDi,
 *   isQiangGang,
 *   isTianHu,
 *   isDiHu
 * }
 */
export function calculateFan(fanInfo, opt) {
  const details = [];
  let fan = 0;

  // ---------------------------------------------------------
  // 1. 花台
  // ---------------------------------------------------------
  if (opt.flowers > 0) {
    fan += opt.flowers;
    details.push({ name: "花牌", fan: opt.flowers });
  }

  // ---------------------------------------------------------
  // 2. 自摸
  // ---------------------------------------------------------
  if (fanInfo.isSelfDraw) {
    fan += 1;
    details.push({ name: "自摸", fan: 1 });
  }

  // ---------------------------------------------------------
  // 3. 門前清
  // ---------------------------------------------------------
  if (fanInfo.isMenQing) {
    fan += 1;
    details.push({ name: "門前清", fan: 1 });

    // 門清自摸（額外 +1）
    if (fanInfo.isSelfDraw) {
      fan += 1;
      details.push({ name: "門清自摸", fan: 1 });
    }
  }

  // ---------------------------------------------------------
  // 4. 對對胡（碰碰胡）
  // ---------------------------------------------------------
  if (opt.isPengPeng) {
    fan += 1;
    details.push({ name: "對對胡", fan: 1 });
  }

  // ---------------------------------------------------------
  // 5. 清一色 / 混一色
  // ---------------------------------------------------------
  if (fanInfo.color === "清一色") {
    fan += 3;
    details.push({ name: "清一色", fan: 3 });
  } else if (fanInfo.color === "混一色") {
    fan += 2;
    details.push({ name: "混一色", fan: 2 });
  }

  // ---------------------------------------------------------
  // 6. 老少副（123 or 789）
  // ---------------------------------------------------------
  if (opt.has123) {
    fan += 1;
    details.push({ name: "老副（123）", fan: 1 });
  }
  if (opt.has789) {
    fan += 1;
    details.push({ name: "少副（789）", fan: 1 });
  }

  // ---------------------------------------------------------
  // 7. 海底 / 河底
  // ---------------------------------------------------------
  if (opt.isHaiDi) {
    fan += 1;
    details.push({ name: "海底撈月", fan: 1 });
  }

  if (opt.isHeDi) {
    fan += 1;
    details.push({ name: "河底撈魚", fan: 1 });
  }

  // ---------------------------------------------------------
  // 8. 搶槓胡
  // ---------------------------------------------------------
  if (opt.isQiangGang) {
    fan += 1;
    details.push({ name: "搶槓胡", fan: 1 });
  }

  // ---------------------------------------------------------
  // 9. 天胡（3 台）
  // ---------------------------------------------------------
  if (opt.isTianHu) {
    fan += 3;
    details.push({ name: "天胡", fan: 3 });
  }

  // ---------------------------------------------------------
  // 10. 地胡（2 台）
  // ---------------------------------------------------------
  if (opt.isDiHu) {
    fan += 2;
    details.push({ name: "地胡", fan: 2 });
  }

  // ---------------------------------------------------------
  // 返回最後結果
  // ---------------------------------------------------------
  return {
    totalFan: fan,
    details,
  };
}
